#!/usr/bin/env node
/**
 * Integration test with real LLM service
 * Tests NegativePromptGenerator with actual LocalLLMProvider
 */

const NegativePromptGenerator = require('./src/utils/negative-prompt-generator');
const LocalLLMProvider = require('./src/providers/local-llm-provider');

async function testRealLLM() {
  console.log('ðŸ§ª Testing NegativePromptGenerator with real LLM service\n');
  console.log('='.repeat(80));

  // Create real LLM provider
  const llmProvider = new LocalLLMProvider({
    apiUrl: 'http://localhost:8003',
    model: 'mistralai/Mistral-7B-Instruct-v0.2'
  });

  // Wrap LocalLLMProvider to match expected interface
  const wrappedProvider = {
    async generateCompletion(prompt, options) {
      // LocalLLMProvider uses a different method name
      // We need to construct a proper request format
      const response = await llmProvider._retryWithBackoff(async () => {
        const axios = require('axios');
        const result = await axios.post(`${llmProvider.apiUrl}/v1/completions`, {
          model: llmProvider.model,
          prompt,
          max_tokens: options.maxTokens || 150,
          temperature: options.temperature || 0.3,
          top_p: 0.9,
          stop: options.stop || []
        });
        return result.data;
      }, {
        operationName: 'Generate negative prompt',
        attemptRestart: true
      });

      return {
        text: response.choices[0].text,
        model: response.model
      };
    }
  };

  const generator = new NegativePromptGenerator({
    llmProvider: wrappedProvider
  });

  // Test cases
  const testCases = [
    {
      prompt: '30 year old man',
      description: 'Should handle age disambiguation'
    },
    {
      prompt: 'beautiful sunset over mountains',
      description: 'Should reinforce desired elements'
    },
    {
      prompt: 'old wooden barn in countryside',
      description: 'Should not negate desired "old"'
    }
  ];

  for (const testCase of testCases) {
    console.log(`\nðŸ“ ${testCase.description}`);
    console.log(`Positive: "${testCase.prompt}"`);

    try {
      const result = await generator.generateNegativePrompt(testCase.prompt);

      console.log(`Negative: "${result.negativePrompt}"`);
      console.log(`Generation time: ${result.metadata.generationTime}ms`);
      console.log(`Model: ${result.metadata.model}`);
      console.log(`Auto-generated: ${result.metadata.autoGenerated}`);

    } catch (error) {
      console.error(`âŒ Error: ${error.message}`);
    }

    console.log('-'.repeat(80));
  }

  console.log('\nâœ¨ Real LLM integration test complete!\n');
}

// Run test
testRealLLM().catch(error => {
  console.error('Fatal error:', error);
  process.exit(1);
});
