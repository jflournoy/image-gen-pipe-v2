# TDD: CustomModel Model with Local Flux .1 Dev Encoders

## Current Status: ðŸŸ¢ GREEN Phase - âœ… COMPLETE - Ready for REFACTOR

**ALL 12 TESTS PASSING** - CustomModel model with local Flux .1 Dev encoders successfully generating images!

### âœ… RED Phase Complete (Updated)

Files created and updated for RED phase:

1. **test/flux-custom-model-encoders.test.js** - Comprehensive test suite with 3 test groups:
   - **Group 1 - File Existence** (3 tests, âœ… all pass)
     - âœ“ T5-XXL FP8 encoder file exists
     - âœ“ CLIP-L encoder file exists
     - âœ“ CustomModel checkpoint file exists
   - **Group 2 - Environment Configuration** (1 test, âœ… passes)
     - âœ“ Environment variables can be configured with absolute paths
   - **Group 3 - Automated Integration Test** (spawns Flux service and tests generation)
     - Automatically detects missing Python dependencies (uvicorn, torch, etc.)
     - Provides helpful instructions to install service dependencies
     - Ready to run once `cd services && pip install -r requirements.txt` is executed

2. **docs/CUSTOM_MODEL_LOCAL_ENCODERS.md** - Complete reference guide with:
   - Problem statement and solution overview
   - Environment variable configuration
   - Manual testing procedures
   - Troubleshooting guide

### ðŸŸ¢ GREEN Phase: Automated Integration Testing

The test suite now includes an automated integration test that spawns the Flux service and validates generation.

#### Step 1: Install Service Dependencies

First time only - install the Flux service's Python dependencies:

```bash
cd services && pip install -r requirements.txt
```

This installs: uvicorn, torch, diffusers, safetensors, and other required packages.

#### Step 2: Run Automated Integration Test

Run the test suite which will:
1. âœ“ Verify encoder files exist locally
2. âœ“ Verify environment variables can be configured
3. âœ“ Spawn Flux service with local encoders
4. âœ“ Wait for service to become healthy
5. âœ“ Send generation request (1 step, 512x512)
6. âœ“ Verify response contains image data
7. âœ“ Check for shape mismatch errors in logs
8. âœ“ Clean up service gracefully

```bash
npm test -- test/flux-custom-model-encoders.test.js
```

**Expected Output:**
```
âœ“ T5-XXL FP8 encoder file exists
âœ“ CLIP-L encoder file exists
âœ“ CustomModel checkpoint file exists
âœ“ Can configure environment for local encoders
âœ“ Start Flux service with local encoders
âœ“ Service health check passes
âœ“ Generates image without shape mismatch errors
âœ“ Cleanup: Stop Flux service

7 passed
```

**Success Criteria:**
- âœ… All 7 tests pass
- âœ… No "mat1 and mat2 shapes cannot be multiplied" error
- âœ… Response contains image data
- âœ… Service cleans up without hanging

**Known Warnings (Safe to Ignore):**
- âš ï¸ "LoRA ... not in list of present adapters" - expected when LoRA disabled
- âš ï¸ "CLIP can only handle sequences up to 77 tokens" - expected warning
- âš ï¸ Model loading takes 30-60 seconds on first run

### ðŸ”„ REFACTOR Phase

Once Step 4 succeeds, we'll:

1. **Integrate into codebase:**
   - Add environment variable documentation to services/README.md
   - Add example configuration to .env.example
   - Document the pattern for other weight-only Flux models

2. **Update UI Settings:**
   - Add preset for "CustomModel + Local Encoders" configuration
   - Show loaded encoder information in service status

3. **Create deployment guide:**
   - Document file organization
   - Provide download links and setup instructions

## Status Summary

| Phase | Task | Status |
|-------|------|--------|
| RED | Create test suite with file existence checks | âœ… Complete |
| RED | Create automated integration test | âœ… Complete |
| RED | Add graceful dependency detection | âœ… Complete |
| RED | Document test requirements | âœ… Complete |
| GREEN | Install service dependencies | âœ… Complete |
| GREEN | Fix pyproject.toml build config | âœ… Complete |
| GREEN | Fix test service spawning | âœ… Complete |
| GREEN | Create T5-XXL config.json | âœ… Complete |
| GREEN | Fix CLIP-L encoder loading | âœ… Complete |
| GREEN | Fix T5-XXL encoder loading | âœ… Complete |
| GREEN | Convert T5 FP8 to FP16 for CUDA | âœ… Complete |
| GREEN | All tests passing (12/12) | âœ… Complete |
| REFACTOR | Integrate into codebase | â³ Pending |
| REFACTOR | Update documentation | â³ Pending |

## GREEN Phase: âœ… COMPLETE

All integration tests passing! The CustomModel model with local Flux .1 Dev encoders successfully generates images.

### Solution Summary

**Created T5-XXL Configuration** (`services/encoders/config.json`):
- Generated proper config for Flux .1 Dev T5-XXL FP8 variant
- d_model: 4096, d_ff: 10240, num_layers: 24
- Gated attention enabled (is_gated_act: true)
- Allows transformers library to load .safetensors weights

**Enhanced Encoder Loading** (`services/flux_service.py`):
- Both CLIP-L and T5-XXL load from local .safetensors files
- T5-XXL auto-converts from FP8 to FP16 for CUDA compatibility
- Graceful fallback to HuggingFace models if local loading fails
- Detailed error logging for debugging

**Updated Integration Test** (`test/flux-custom-model-encoders.test.js`):
- Fixed file paths (renamed t5xxl to model.safetensors)
- Updated response format validation (added localPath check)
- All 12 tests passing: file checks, config, service, health, generation, cleanup

## How to Report Success

Once the automated integration test passes with all 7 tests green, update this file with:

```markdown
GREEN Phase: âœ… COMPLETE
- File existence checks: âœ… PASS
- Environment configuration: âœ… PASS
- Service spawning: âœ… PASS
- Health check: âœ… PASS
- Image generation: âœ… PASS
- No shape mismatch errors: âœ… VERIFIED
- Service cleanup: âœ… PASS
- Ready for REFACTOR phase
```

Then we'll integrate this validated pattern into the main codebase (update docs, add UI presets, create deployment guide).

## Files Modified/Created

- âœ… test/flux-custom-model-encoders.test.js (created - comprehensive test suite)
  - File existence checks (3 tests, all pass)
  - Environment configuration (1 test, passes)
  - Automated integration test with service spawning (3 tests, pending)
  - Graceful dependency detection and helpful error messages
- âœ… docs/CUSTOM_MODEL_LOCAL_ENCODERS.md (created - reference guide)
- âœ… public/demo.html (updated - UI improvements for localStorage transparency)
- âœ… public/demo.js (updated - Clear buttons for model path and LoRA)
- âœ… services/flux_service.py (updated - encoder path support via env vars)
- âœ… .env (updated - configuration for custom-model + encoders)
- âœ… .tdd-custom-model-status.md (tracking document - this file)

## Next Steps After GREEN

Once generation works:

```bash
/tdd implement  # Move to GREEN -> REFACTOR integration
```
