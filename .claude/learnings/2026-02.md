# Learnings - 2026-02

## 2026-02-11 - 09:52
Face Fixing Color Preservation: GFPGAN inherently shifts colors during enhancement. The blending weight parameter alone doesn't help - the color shift happens in GFPGAN's internal processing. Solution: post-process color correction using LAB color space to match original color statistics (mean/std per channel) while preserving detail enhancements. Made these API parameters (gfpgan_arch, gfpgan_preserve_color) instead of environment variables for dynamic testing without service restarts.

## 2026-02-11 - 09:52
Testing Strategy for Slow Services: When services take 10-30 minutes to load (like Flux models), create direct module test scripts that import and reload the code without starting the full service. Example: /tmp/test_color_correction_direct.py imports face_fixing module directly, avoiding full Flux reload. Use module importlib.reload() to pick up code changes.

## 2026-02-11 - 09:53
API Design: Environment variables are poor UX for parameters that need experimentation - they require service restarts. Make them API parameters instead so users can test different values dynamically. Good pattern: check both API param and env var fallback for backward compatibility.

## 2026-02-11 - 09:53
Quantitative Testing Tools: For subjective quality metrics (like color preservation), build analysis tools that generate quantitative data. Delta E in LAB color space is industry-standard for perceptual color difference. Create test scripts that compare before/after with metrics AND visual side-by-sides. Put these in test/analysis/ not test/integration/.

## 2026-02-11 - 09:53
CodeFormer vs GFPGAN Dependencies: CodeFormer ships with old basicsr incompatible with modern PyTorch/torchvision. GFPGAN works with basicsr-fixed. Can't use both simultaneously without extensive patching. For now, GFPGAN + post-processing color correction is the practical solution for color preservation.

