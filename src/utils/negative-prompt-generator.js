/**
 * Negative Prompt Generator
 * Uses LLM to intelligently generate negative prompts for SDXL image generation
 */

/**
 * Default fallback negative prompt when LLM generation fails
 */
const DEFAULT_FALLBACK = 'blurry, low quality, distorted, deformed, artifacts';

/**
 * System prompt for LLM negative prompt generation
 */
const SYSTEM_PROMPT = `You are an expert at generating negative prompts for SDXL image generation.

Your task: Given a positive prompt, generate a negative prompt that:
1. Prevents common artifacts (blurry, low quality, distorted, deformed, etc.)
2. Disambiguates ambiguous terms (e.g., "old" in "30 year old" should be negated as "elderly, aged")
3. Prevents opposite characteristics from the desired result
4. Reinforces desired elements by excluding their absence (e.g., "no mountains" if mountains are wanted)
5. Does NOT negate the core subject or desired attributes

Examples:

Positive: "30 year old man"
Negative: "elderly, aged, wrinkled, senior, young, child, teenager, blurry, low quality, distorted"

Positive: "old wooden barn"
Negative: "modern, new, metal, glass, blurry, low quality, distorted, people, cars"

Positive: "beautiful sunset over mountains"
Negative: "blurry, low quality, no mountains, flat, urban, city, text, watermark"

Now generate a negative prompt for the following positive prompt. Output ONLY the negative prompt, nothing else.`;

/**
 * NegativePromptGenerator class
 * Generates negative prompts using an LLM provider
 */
class NegativePromptGenerator {
  /**
   * @param {Object} options - Configuration options
   * @param {Object} options.llmProvider - LLM provider instance with generateCompletion method
   * @param {string} options.fallback - Default fallback negative prompt
   * @param {number} options.temperature - LLM temperature (default: 0.3 for consistency)
   * @param {number} options.maxTokens - Max tokens for generation (default: 150)
   */
  constructor(options = {}) {
    this.llmProvider = options.llmProvider;
    this.fallback = options.fallback || DEFAULT_FALLBACK;
    this.temperature = options.temperature ?? 0.3;
    this.maxTokens = options.maxTokens ?? 150;
  }

  /**
   * Generate negative prompt from positive prompt
   * @param {string} positivePrompt - The positive prompt
   * @param {Object} options - Generation options
   * @param {boolean} options.enabled - Whether auto-generation is enabled (default: true)
   * @param {string} options.fallback - Custom fallback for this generation
   * @returns {Promise<Object>} Result with negativePrompt and metadata
   */
  async generateNegativePrompt(positivePrompt, options = {}) {
    const startTime = Date.now();
    const enabled = options.enabled !== false;
    const fallback = options.fallback || this.fallback;

    // If disabled, return empty negative
    if (!enabled) {
      return {
        negativePrompt: '',
        metadata: {
          autoGenerated: false,
          generationTime: 0,
          model: null
        }
      };
    }

    // Handle empty prompt
    if (!positivePrompt || positivePrompt.trim().length === 0) {
      return {
        negativePrompt: fallback,
        metadata: {
          autoGenerated: false,
          generationTime: Date.now() - startTime,
          model: null,
          usedFallback: true
        }
      };
    }

    // Try to generate with LLM
    try {
      const prompt = `${SYSTEM_PROMPT}\n\nPositive prompt: "${positivePrompt}"\n\nNegative prompt:`;

      const result = await this.llmProvider.generateCompletion(prompt, {
        temperature: this.temperature,
        maxTokens: this.maxTokens,
        stop: ['\n\n', 'Positive:', 'Example:']
      });

      const negativePrompt = result.text.trim();
      const generationTime = Date.now() - startTime;

      return {
        negativePrompt,
        metadata: {
          autoGenerated: true,
          generationTime,
          model: result.model || 'unknown',
          usedFallback: false
        }
      };
    } catch (error) {
      // LLM failed, use fallback
      const generationTime = Date.now() - startTime;

      return {
        negativePrompt: fallback,
        metadata: {
          autoGenerated: false,
          generationTime,
          model: null,
          error: error.message,
          usedFallback: true
        }
      };
    }
  }
}

module.exports = NegativePromptGenerator;
