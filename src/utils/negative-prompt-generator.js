/**
 * Negative Prompt Generator
 * Uses LLM to intelligently generate negative prompts for SDXL image generation
 */

const { getNegativeSystemPrompt } = require('../prompts');

/**
 * Default fallback negative prompt when LLM generation fails
 */
const DEFAULT_FALLBACK = 'blurry, low quality, distorted, deformed, artifacts';

/**
 * NegativePromptGenerator class
 * Generates negative prompts using an LLM provider
 */
class NegativePromptGenerator {
  /**
   * @param {Object} options - Configuration options
   * @param {Object} options.llmProvider - LLM provider instance with generateCompletion method
   * @param {string} options.fallback - Default fallback negative prompt
   * @param {number} options.temperature - LLM temperature (default: 0.3 for consistency)
   * @param {number} options.maxTokens - Max tokens for generation (default: 150)
   */
  constructor(options = {}) {
    this.llmProvider = options.llmProvider;
    this.fallback = options.fallback || DEFAULT_FALLBACK;
    this.temperature = options.temperature ?? 0.3;
    this.maxTokens = options.maxTokens ?? 150;
  }

  /**
   * Generate negative prompt from positive prompt
   * @param {string} positivePrompt - The positive prompt
   * @param {Object} options - Generation options
   * @param {boolean} options.enabled - Whether auto-generation is enabled (default: true)
   * @param {string} options.fallback - Custom fallback for this generation
   * @returns {Promise<Object>} Result with negativePrompt and metadata
   */
  async generateNegativePrompt(positivePrompt, options = {}) {
    const startTime = Date.now();
    const enabled = options.enabled !== false;
    const fallback = options.fallback || this.fallback;

    // If disabled, return empty negative
    if (!enabled) {
      return {
        negativePrompt: '',
        metadata: {
          autoGenerated: false,
          generationTime: 0,
          model: null
        }
      };
    }

    // Handle empty prompt
    if (!positivePrompt || positivePrompt.trim().length === 0) {
      return {
        negativePrompt: fallback,
        metadata: {
          autoGenerated: false,
          generationTime: Date.now() - startTime,
          model: null,
          usedFallback: true
        }
      };
    }

    // Try to generate with LLM
    try {
      const selectedSystemPrompt = getNegativeSystemPrompt({ promptStyle: options.promptStyle });
      const prompt = `${selectedSystemPrompt}\n\nPositive prompt: "${positivePrompt}"\n\nNegative prompt:`;

      const result = await this.llmProvider.generateCompletion(prompt, {
        temperature: this.temperature,
        maxTokens: this.maxTokens,
        stop: ['\n\n', 'Positive:', 'Example:']
      });

      const negativePrompt = result.text.trim();
      const generationTime = Date.now() - startTime;

      return {
        negativePrompt,
        metadata: {
          autoGenerated: true,
          generationTime,
          model: result.model || 'unknown',
          usedFallback: false
        }
      };
    } catch (error) {
      // LLM failed, use fallback
      const generationTime = Date.now() - startTime;

      return {
        negativePrompt: fallback,
        metadata: {
          autoGenerated: false,
          generationTime,
          model: null,
          error: error.message,
          usedFallback: true
        }
      };
    }
  }
}

module.exports = NegativePromptGenerator;
